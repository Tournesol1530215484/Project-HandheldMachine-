{template 'common/header1111'} <!-- header跟以往不一样 区别图标库 font-awesome是20180930前最新版 -->
<title>早起打卡</title>
<!-- <link rel="stylesheet" href="../addons/sz_yi/static/css/mui.min.css">
<link rel="stylesheet" href="../addons/sz_yi/static/css/mui.picker.min.css"> -->
<link rel="stylesheet" type="text/css" href="<?php echo MODULE_URL.'plugin/activity/res/css/signin.css';?>"/>
<!-- <script type="text/javascript" src="../addons/sz_yi/static/js/mui.min.js"></script>
<script type="text/javascript" src="../addons/sz_yi/static/js/mui.picker.min.js"></script> -->
<div class="big_body">
    <div class="page_topbar">
        <a href="javascript:;" class="back" onclick="history.back()"><i class="fa fa-angle-left"></i></a>
        <div class="title">早起打卡</div>
    </div>
    <div class="top-box" style="background: #10BDFF;">
        <div class="flex-center">
            <div class="punch-box">
                <i class="fa fa-calendar-check-o" aria-hidden="true"></i>
                <span class="sign-days">{$max}天</span>
            </div>
            <div class="user-box">
                <div class="user-headicon">
                    <img class="user-icon" src="{$heMember['avatar']}">
                </div>
            </div>
            <div class="punch-box punch-box-l">
                <a class="card-link" href="{php echo $this->createPluginMobileUrl('activity/center',array('op'=>'card'))}">打卡二维码</a>
            </div>
        </div>
        <div class="user-name-box">{$heMember['nickname']}({$heMember['id']})</div>
        {if false}
        <div class="signature">传播健康大道，唤醒人人成为自己的医生</div>
        {/if}
        <div class="specific-data-box">
            <ul class="specific-data-ul flex-center">
                <li class="specific-data-item">  
                    <div class="nowrap-box">{$tedaycount}人</div>
                    <div class="specific-data-title nowrap-box">今日打卡</div>
                </li>
                <li class="specific-data-item">      
                    <div class="nowrap-box">{$totals}人</div>
                    <div class="specific-data-title nowrap-box">总打卡</div>
                </li>
                <li class="specific-data-item">
                    <div class="nowrap-box">{if $yestdayPeople<$tedayPeople}{php echo $tedayPeople -  $yestdayPeople} {else}0{/if}人</div>
                    <div class="specific-data-title nowrap-box">今日新增</div>
                </li>                                     
                <li class="specific-data-item">                                                   
                    <div class="nowrap-box">{if $tedayBorwse}{$tedayBorwse}{else}0{/if}人</div>
                    <div class="specific-data-title nowrap-box">日访量</div>
                </li>
            </ul>
        </div>
    </div>
    <div class="nav-container status-nav-container">
        <ul class="nav-box clearfloat">
            <a class="nav-item-link nav-on nav-item-link1" href="javascript:void(0);" data-status="1">
                <li class="nav-item nav-name">
                   <i class="fa fa-calendar" aria-hidden="true"></i>今日
                </li>
            </a>
            <a class="nav-item-link nav-item-link2" href="javascript:void(0);" data-status="2">
                <li class="nav-item nav-name">
                   <i class="fa fa-sort-amount-desc" aria-hidden="true"></i>排行榜
                   <i class="fa fa-angle-down sort-mark" aria-hidden="true"></i>
                   <ul class="sort-type" style="display: none;">
                       <li class="sort-type-item" data-type="1">打卡排行榜</li>
                       <li class="sort-type-item" data-type="2">赚钱排行榜</li>
                   </ul>
                </li>
            </a>
            <a class="nav-item-link nav-item-link1" href="javascript:void(0);" data-status="3">
                <li class="nav-item nav-name">
                   <i class="fa fa-compass sizebigger" aria-hidden="true"></i>{if true}我的{else}TA的{/if}
                </li>
            </a>
            <!-- <a class="nav-item-link" href="javascript:void(0);" data-status="4">
                <li class="nav-item nav-name">
                   <i class="fa fa-users" aria-hidden="true"></i>团队
                </li>
            </a> -->
        </ul>
    </div>
    <div class="list-box">
        <div class="my-tlp-box"></div>
        <ul class="list-ul ad-container">      
            <!-- 下拉加载数据容器 -->
        </ul> 
    </div>
    <div class="multiple-container" style="display: none;">
        <div class="multiple-item">
            <div class="mul-company-item"><span class="mul-company-name">《{$muser['orgName']}》(加油0|支持0|人气0)</span></div>
            <div class="mul-company-intro">{$activity['descOrg']}</div>
        </div>
        <!-- 点赞部分 -->
        <div class="praise-user-container">
            <ul class="praise-user-ul clearfloat">
                <!-- 这里内置标签开始循环li元素  -->
                {loop $like $k $v}
                <li class="praise-user-item">
                    <img class="user-icon" src="{$v['avatar']}" onclick="console.log('hi')">
                </li>       
                {/loop}
            </ul>
        </div>
        <!-- 打赏部分 -->
        <div class="reward-user-container">
            <ul class="reward-user-ul">
                <!-- 这里内置标签开始循环li元素  -->
                {loop $reward $k $v}
                    <li class="reward-user-item">
                        <a class="reward-user-link" href="javascript:void(0);" onclick="console.log('hi')" style="color:#000;display:block;text-align:left"><img class="face_reward" src="{$v['avatar']}" style="vertical-align:middle">
                            <span>{$v['nickname']}<!-- {$v['mobile']} --> 支持了 <span style="color:red">{$v['money']}</span>元，{$v['remark']}</span>
                        </a>
                    </li>
                {/loop}
            </ul>
        </div>
        <!-- 评论部分 -->
        <div class="comment-user-container">
            <ul class="comment-user-ul">
                <!-- 这里内置标签开始循环li元素  -->
                {loop $comment $k $v}
                <li class="comment-user-item">
                    <a class="comment-user-link" href="javascript:void(0);" onclick="console.log('hi')" style="color:#000;display:block;text-align:left"><img class="face_comment" src="{$v['avatar']}" style="vertical-align:middle">      
                        <span>{$v['nickname']}{$v['mobile']} {$v['content']}</span>
                    </a>
                </li>
                {/loop}
            </ul>
        </div>
        <div class="btn-container-0">
            <ul class="btn-box clearfloat">
                <li class="btn-item praise-btn-item">
                    <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>
                </li>
                <li class="btn-item reward-btn-item"><!-- 这里是跳转到打赏界面 -->
                    <a class="btn-link" href="{php echo $this->createPluginMobileUrl('activity/center',array('op'=>'reward','type'=>'3','id'=>$id))}">赏</a>
                </li>
                <li class="btn-item comment-btn-item" onclick="showdescription()">评</li>        
                <li class="btn-item"><!-- 这里是跳转到帮助手册(文章) -->
                    <a class="btn-link" href="{php echo $this->createPluginMobileUrl('article/article')}"><i class="fa fa-question" aria-hidden="true"></i></a>
                </li>
            </ul>       
        </div>
    </div>
    <div style="height:55px; width:100%;margin:0;padding:0;"></div>
    <div class="foot-btn btn-container-1">
        <ul class="btn-box clearfloat"><!-- 某些按钮跳转到对应的页面 -->
            <!-- <li class="btn-item btn-link-box">
                <a class="btn-link card" href="{php echo $this->createPluginMobileUrl('activity/center',array('op'=>'card'))}">卡片</a>
            </li> -->
            <li class="btn-item">
                <a class="btn-link" href="{php echo $this->createMobileUrl('barter/bonus',array('op'=>'bonusIndex'))}">拆红包</a>
            </li>
            <li class="btn-item">
                <a class="btn-link mysignin" href="javascript:void(0);">我要打卡</a>
            </li>
            <li class="btn-item">
                <a class="btn-link" href="http://jhzh66.com/app/index.php?i=8&c=entry&do=barter&m=sz_yi">换货商城</a>
            </li>
            <!-- 这里跳转到团队打卡列表页面,要修改跳转链接 -->
            <!-- <li class="btn-item">
                <a class="btn-link" href="javascript:void(0);">团队打卡</a>
            </li> -->
        </ul>       
    </div>
    <div class="go-to-top-con">
        <a class="gotop" id="gotop" data-i=""><i class="fa fa-caret-up icon-block" aria-hidden="true"></i>TOP</a>
    </div>
    <!-- 借用说明的类似结构实现蒙层和弹出框 进行评论-->
    <div class="description_layer"></div> 
    <div class="description">
        <div class="description-tag">评论</div>
        <div class="description-cont"><!-- 评论输入框 -->
           <textarea class="comment-textarea" placeholder="最多50字" maxlength="50"></textarea>
        </div>
        <div class="comment-post-btn">提交</div>
        <div class="close icon" onClick="closedescription()"></div>
    </div>
</div>
<!-- 两种模板 用户打卡记录 或者 打卡暂无数据为空 -->
<!-- 今日模板 -->
<script id="tpl_list1" type="text/html">
    <%each list as g index%>
        <li class="list-item" onclick="console.log('hi')">
            <%if index%2 == 1%>
            <%/if%>          
            <span class="serial-num"><%g.no%></span>
            <img class="user-avatar" src="<%g.avatar%>">
            <%g.nickname%>
            <%g.ctime%>
            积分+<%g.score%>
        </li>
    <%/each%>
</script>
<!-- 排行榜模板 -->                  
<script id="tpl_list2" type="text/html">                 
    <%each list as g index%>         
        <li class="list-item" onclick="location.href='<%g.link%>'">
            <img class="user-avatar" src="<%g.avatar%>">
            <%g.nickname%>      
            连续打卡<span class="total-days-val"><%g.continuous%></span>天
            总积分: <%g.score%>
        </li>
    <%/each%>
</script>
<!-- 我的或者TA的 模板 -->
<script id="tpl_list3" type="text/html">
    <%each list as g index%>
        <li class="list-item" onclick="console.log('hi')">
            <img class="user-avatar" src="<%g.avatar%>">
            <%g.nickname%>
            <%g.ctime%>
            积分+<%g.score%>
        </li>
    <%/each%>
</script>
<!-- 团队模板 这个比较特殊 返回带上时间 -->
<!-- <script id="tpl_list4" type="text/html">
    <li class="list-item list-item-center">2018-09-30</li>
    <%each list as g index%>
        <li class="list-item" onclick="console.log('hi')">
            <img class="user-avatar" src="http://jhzh66.com/attachment/images/8/2018/09/ZglggmzYzyZrzX3MMxp3KRqgkjkRIg.png">
            桂花糕
            05:00:09
            积分9+ 
            红包<span class="bonus-val">+0.56</span>
        </li>
    <%/each%>
    <%if list.length == 0%>
        <div class="no-list">暂无打卡记录</div>
    <%/if%>
</script> -->
<script id="tpl_null" type="text/html">
    <div class="no-list">暂无打卡记录</div>
</script>
<!-- 今日标签用户自己的打卡数据 -->
<script id="tpl_myrecord1" type="text/html">
    <div class="my-sign-in"> <!-- 这个是本人的打卡信息 -->
        <img class="user-avatar" src="<%mysign.avatar%>">
        <%mysign.nickname%>
        <%mysign.ctime%>
        积分+<%mysign.score%>
    </div>
</script>
<!-- 排行榜标签用户自己的打卡数据 -->
<script id="tpl_myrecord2" type="text/html">
    <div class="my-sign-in"> <!-- 这个是本人的打卡信息 -->
        <img class="user-avatar" src="<%mysign.avatar%>">
        <%mysign.nickname%>         
        连续打卡<span class="total-days-val"><%mysign.continuous%></span>天
        总积分: <%mysign.score%>
    </div>
</script>
<!-- 点赞记录模板 当用户点赞时用到 填充两个数据点赞用户头像和用户的打卡界面链接-->
<script  id="tpl_praise" type="text/html">
    <li class="praise-user-item">                          
        <img class="user-icon" src="<%member.avatar%>" onclick="console.log('hi')">
    </li>
</script>
<script type="text/javascript">
    //主要靠status来选择用哪个模板,四种打卡模板,两种用户自己打卡标志的模板,还有空打卡记录的模板
    var args  = {
        tpl: "tpl_list1",//默认进入页面加载的模板
        mytpl: "tpl_myrecord1",//默认进入页面加载置顶显示的用户自己的模板
        page: 1,
        ac:'get',                                
        mmid:'{$_GPC['mmid']}',
        status: 1
    }; 
    require(['tpl', 'core'], function(tpl, core) {               
        menushowheight();                        
        $(window).scroll(function() {       
            menushowheight();  
        });
        $("#gotop").click(function(){
            $("html,body").stop().animate({scrollTop: 0}, 500);
        });
        $('.nav-item-link1').click(function() { 
            $(".sort-type").hide();
            $(".sort-type-item").each(function(){
                $(this).removeClass("nav-on");
            });
            var status = $(this).data('status'); 
            $(this).addClass("nav-on").siblings().removeClass("nav-on");
            args.page = 1;
            args.status = status;
            args.tpl = "tpl_list"+status;
            args.mytpl = "tpl_myrecord"+status;
            getList(args);
        });  
        //处理排行榜点击显示隐藏事件
        $('.nav-item-link2').click(function() { 
            $(this).find(".sort-type").toggle();
        });
        //处理各类型排行榜点击事件
        $('.sort-type-item').click(function() { 
            var type = $(this).data('type');
            $(this).addClass("nav-on").siblings().removeClass("nav-on");
            $(this).parent().parent().parent().addClass("nav-on").siblings().removeClass("nav-on");
            //打卡排行榜
            if(type == 1){ //如果type==1说明是打卡排行榜，借用原来的的函数来实现功能,type非的话使用下面的
                var status = 2;
                args.page = 1;
                args.status = status;
                args.tpl = "tpl_list"+status;
                args.mytpl = "tpl_myrecord"+status;
                getList(args);
            }else{
                location.href='{php echo $this->createPluginMobileUrl('activity/center',array("op"=>"sort"))}';
            }
        });
        getList(args);
        $(".praise-btn-item").click(function(){
            core.pjson('activity/index', {op:'like',type:'3',id:'{$id}'}, function(json) {
                //json.status 这里的标识字段随便取，跟后台返回的对应就可以了
                if (json.status == 1) {
                    core.tip.show('加油成功','bottom',500);
                    $(".praise-user-ul").append(tpl('tpl_praise',json.result));
                    return;      
                }
                core.tip.show('你已经加油过了','bottom',500);
            }, true);
        });
        $(".comment-post-btn").click(function(){
            if($(".comment-textarea").isEmpty()){
                core.tip.show('评论不能为空');
                return;
            }
            var comment = $(".comment-textarea").val();
            core.pjson('activity/index', {op:'comment',type:'3',id:'{$id}',comment: comment}, function(json) {
                //json.status 这里的标识字段随便取，跟后台返回的对应就可以了       
                if (json.status == 1) {
                    core.tip.show('评论成功,等待作者审核');//评论不会即时出现,需要审核,也就是刷新页面的时候才可能会出现评论(才加载)
                    // $(".comment-user-ul").append(tpl('tpl_praise'),json.result);
                    closedescription();                                                                 
                    return;
                }
                core.tip.show(json.result);
            }, true);
        });              
        $(".mysignin").click(function(){
            core.pjson('activity/center', {ac:'signin',id:'{$id}'}, function(json) {           
                //json.status 这里的标识字段随便取，跟后台返回的对应就可以了       
                if (json.status == 1) {
                    //core.tip.confirm(json.result);//用下面的信息提示结构
                    //core.tip.confirm(json.msg);//自定义信息msg长度不要过长,30字以内
                    alert(json.result);
                    setTimeout(function(){
                        location.href='{php echo $this->createPluginMobileUrl('activity/center')}';
                    },500);
                    return;      
                }           
                core.tip.confirm(json.result);//用下面的信息提示结构      
                //core.tip.confirm(json.msg);//自定义信息msg长度不要过长,30字以内
            }, true);
        });
        function getList(page){
            core.pjson("activity/center", args, function(json) {
                if (json.result.list.length <= 0) {
                    $(".list-box .list-ul").html(tpl('tpl_null'));
                    return;
                }
                //这里赋值用户本人自己相关的打卡记录或者处理没有单独置顶自己记录的请求
                if(args.status == 1 || args.status == 2){       
                    if (json.result.mysign != '' ) {
                        $(".list-box .my-tlp-box").html(tpl(args.mytpl,json.result));
                    }           
                }else{
                    $(".list-box .my-tlp-box").html("");
                }
                $(".list-box .list-ul").html(tpl(args.tpl,json.result));
                $('.list-box .list-ul').append('<div id="list_loading" class="getmore">点击加载更多</div>');
                var loaded = false;
                var stop = true; 
                getmore(loaded,stop);
            }, true);
        }
        function getmore(loaded,stop){
            $(".getmore").unbind("click").click(function(){ 
                if(loaded){
                    console.log("hhh");
                    return;
                }
                if(stop==true){ 
                    stop=false; 
                    args.page++;
                    core.pjson("activity/center", args, function(morejson) {  
                        stop = true;
                        $('#list_loading').remove();
                        $(".list-box .list-ul").append(tpl(args.tpl, morejson.result));
                        // if (morejson.status == 0) {
                        //     $('.list-box .list-ul').append('<div id="list_loading">已经加载全部</div>');
                        //     loaded = true;
                        //     return;
                        // }else{
                        //     //共用中的特殊,团队打卡的话,每个page加载一天,不会存在'已经加载全部'的情况,主要靠后台设置
                        //     $('.list-box .list-ul').append('<div id="list_loading" class="getmore">点击加载更多</div>');
                        //     getmore(loaded,stop);
                        // }        
                        //到时候返回数据用下面这种数据结构          
                        if (morejson.result.list.length <morejson.result.pagesize) {
                            $('.list-box .list-ul').append('<div id="list_loading">已经加载全部</div>');
                            loaded = true;
                            return;
                        }else{
                            $('.list-box .list-ul').append('<div id="list_loading" class="getmore">点击加载更多</div>');
                            getmore(loaded,stop);
                        }
                    },true); 
                } 
            });
        }
    });
    function menushowheight(){
        var bt=$(window).scrollTop();
        if(bt>=400){
            $("#gotop").slideDown(200);
            $("#gotop").attr({"data-i":"1"});
        }else{
            $("#gotop").slideUp(200);
            $("#gotop").attr({"data-i":""});
        }
    }
    function closedescription(){
        $('.description_layer').fadeOut(100);
        $('.description').fadeOut(100);
    }
    function showdescription(){
        $('.description_layer').fadeIn(200);
        $('.description_layer').unbind('click').click(function(){
            closedescription();
        });
        $('.description').fadeIn(200);
    }
</script>
{template 'common/footer'}