{template 'common/header'}
{template 'pictabs'}
<script type="text/javascript" href="http://jhzh66.com/addons/sz_yi/static/js/dist/area/Area.xml?v=3"></script>
<style type='text/css'>
	.trhead td {  background:#efefef;text-align: center}
	.trbody td {  text-align: center; vertical-align:top;border-left:1px solid #ccc;overflow: hidden;}
	.goods_info{position:relative;width:60px;}
	.goods_info img {width:50px;background:#fff;border:1px solid #CCC;padding:1px;}
	.goods_info:hover {z-index:1;position:absolute;width:auto;}
	.goods_info:hover img{width:320px; height:320px;} 
	#modal-module-qrcode img{left:50%;margin-left:-130px;position: relative;}  
</style>	 		
{if $_GPC['op'] == 'post'} 	 	
<div class="main rightlist"> 		
    <form id="dataform" action="" method="post" class="form-horizontal form" >
        <input type="hidden" name="id" value="{$_GPC['id']}" /> 
        <input type="hidden" name="ac" value="{$_GPC['ac']}" />
        <input type="hidden" name="data[status]" value="{if $picture['status']}{$picture['status']}{else}1{/if}" />
        <div class='panel panel-default' style="border-radius: 5px;">
            <div class='panel-heading' style="background: #eee;">图片基本信息</div>
            <div class='panel-body'>
            	 			 	 			 		 		 		 		 	 	 	 		 		  		 	 	
	            <div class="form-group">
                	<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
	                    <label class="col-xs-12 col-sm-3 col-md-3 control-label"><span style='color:red'>*</span>标题</label>
	                    <div class="col-sm-9 col-xs-12">
	                        {ife 'match.picture' $su_info}
	                        <input type="text" name="data[title]" class="form-control" value="{$picture['title']}" autocomplete="off" />
	                        {else}
	                        <div class='form-control-static'>********</div>
	                        {/if}
	                    </div>
	                </div>
	                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
	                </div>
                </div>


                <div class="form-group">
					<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
						<label class="col-xs-12 col-sm-3 col-md-3 control-label"><span style='color:red'> * </span>封面图</label>
						<div class="col-sm-9 col-xs-12">
							{ife 'match.picture' $su_info}	 	
							{php echo tpl_form_field_image('data[cover]',$picture['cover']);}
							<span class="help-block"> </span>
							{else}	 				 			
								<img src="{php echo tomedia($picture['cover'])}">
							{/if}	 		
							<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
							</div>
						</div> 
					</div>	 		
				</div>


                <div class="form-group">
                	<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
	                    <label class="col-xs-12 col-sm-3 col-md-3 control-label"><span style='color:red'>*</span>摘要</label>
	                    <div class="col-sm-9 col-xs-12">
	                        {ife 'match.picture' $su_info}
	                        <input type="text" name="data[desc]" class="form-control" value="{$picture['desc']}" autocomplete="off" />
	                        {else}
	                        <div class='form-control-static'>********</div>
	                        {/if}
	                    </div>
	                </div>	 		
	                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
	                </div>
                </div>	 		 	

                <div class="form-group">
					<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
						<label class="col-xs-12 col-sm-3 col-md-3 control-label"><span style='color:red'>*</span>图片地点</label>
						<div class="col-sm-9 col-xs-12">  			 	
							{ife 'match.picture' $su_info}
							{php echo tpl_fans_form('reside',array('province' =>$picture['province'],'city' =>$picture['city']));}
							{else}	 		 			
							<div class='form-control-static'>********</div>
							{/if}
						</div>	 	 	
					</div>	 			 		
					<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
					</div>
				</div>

                <div class="form-group">
                	<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
	                    <label class="col-xs-12 col-sm-3 col-md-3 control-label"><span style='color:red'>*</span>发布机构</label>
	                    <div class="col-sm-9 col-xs-12">
	                        {ife 'match.picture' $su_info}
	                        <input type="text" name="data[relOrg]" disabled class="form-control" value="{$muser['orgName']}" autocomplete="off" />
	                        {else}
	                        <div class='form-control-static'>********</div>
	                        {/if}
	                    </div>
	                </div>
	                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
	                </div>
                </div>

                 <div class="form-group">
                	<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
	                    <label class="col-xs-12 col-sm-3 col-md-3 control-label"><span style='color:red'>*</span>机构介绍</label>
	                    <div class="col-sm-9 col-xs-12">
	                        {ife 'match.picture' $su_info}
	                        <textarea class="form-control" disabled name="data[descOrg]">{$muser['orgDesc']}</textarea>
	                        {else} 		
	                        <div class='form-control-static'>********</div>
	                        {/if}
	                    </div>
	                </div>
	                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
	                </div>
                </div>

				<div class="form-group">
					<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
						<label class="col-xs-12 col-sm-3 col-md-3 control-label"><span style='color:red'>*</span>图片类别	</label>
						<div class="col-sm-9 col-xs-12">
							{ife 'match.picture' $su_info}
								<select class="form-control" name="data[type]">
									{loop $cate $v}
										<option {if $picture['type'] == $v['id']}selected{/if} value="{$v['id']}">{$v['title']}</option>										
									{/loop}
								</select>	 		
							{else}
								<div class='form-control-static'>********</div>
							{/if}
						</div>	 		
					</div>
					<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
					</div>
				</div>

				<div class="form-group">
					<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
						<label class="col-xs-12 col-sm-3 col-md-3 control-label"><span style='color:red'>*</span>团队模式</label>
						<div class="col-sm-9 col-xs-12">
							{ife 'match.picture' $su_info}
								<label class="radio-inline">
								  <input type="radio" name="data[teamModel]" {if $picture['teamModel'] == 0}checked{/if} id="inlineRadio1" value="0"> 否     
								</label> 		 
								<label class="radio-inline">
								  <input type="radio" name="data[teamModel]" {if $picture['teamModel'] == 1}checked{/if} id="inlineRadio2" value="1"> 是     
								</label>
							{else}
								<div class='form-control-static'>********</div>
							{/if}
						</div>
					</div>
					<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
					</div>
				</div>

				<div class="form-group">
					<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
						<label class="col-xs-12 col-sm-3 col-md-3 control-label"><span style='color:red'>*</span> 背景音乐</label>
						<div class="col-sm-9 col-xs-12">
							{php echo tpl_form_field_audio('data[bgm]',$picture['bgm']);}
						</div>
					</div>
					<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
					</div>
				</div>


				<div class="form-group">
					<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
						<label class="col-xs-12 col-sm-3 col-md-3 control-label"><span style='color:red'>*</span> 内容</label>
						<div class="col-sm-9 col-xs-12">
							{php echo tpl_ueditor('data[content]',$picture['content']);}
						</div> 		
					</div> 		
					<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
					</div>
				</div>

				<input type="hidden" name="status" value="0">

			</div>
		</div>
                <div class="form-group"></div>
                 <div class="form-group">
                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"></label>
                    <div class="col-sm-9 col-xs-12">
                         {ife 'match.picture' $su_info}

	                        <div class="btn btn-success col-lg-1 draft" style="margin-right: 15px;">保存草稿</div>
	                        <input type="button" name="submit" value="提交" class="btn btn-primary col-lg-1" />
	                        <input type="hidden" name="token" value="{$_W['token']}" />
                        {/if}	 	 		
                       <input type="button" name="back" onclick='history.back()' {ifp 'match.picture.add|match.picture.edit'}style='margin-left:10px;'{/if} value="返回列表" class="btn btn-default col-lg-offset-1" />
                    </div>
                </div>
            </div>	 		

        </div>

		<div class="form-group col-sm-12">
         	
        </div>
    </form>
</div>

{elseif $op == 'display'}

<div class='panel panel-default' style="border-radius: 5px;">
    <div class='panel-heading'>我发布的一共 <span style="color:#f00">{$totals}</span> 篇</div>
	    <div class='panel-body'> 		 
	    	
	    	<table class="table table-hover table-responsive">
	    		<thead class="navbar-inner">
	    			<tr>
	    				<th style="width:auto;">标题</th>
	    				<th style="width:auto;">图片类型</th>
	    				<th style="width:auto;">所属分类</th>
	    				<th style="width:auto;">是否置顶</th>
	    				<th style="width:auto;">浏览数</th>
	    				<th style="width:auto;">点赞数</th>
	    				<th style="width:auto;">分享数</th>
	    				<th style="width:auto;">创建时间</th>
	    				<th style="width:auto;">操作</th>
	    			</tr>
	    		</thead>
	    		<tbody>
	    			{loop $list $index $item}
		    			<tr> 	 	  	 	 	
		    				<td>{$item['title']}</td>
		    				<td>原创</td>
		    				<td>
		    					{if $item['type']}	 			 	  
		    					{$cate[$item['type']]['title']}
		    					{else}
		    					暂无分类
		    					{/if}
		    				</td>	 		 	 		 
		    				<td>
		    					{if $item['is_top'] == 1}
		    						刷新
		    					{elseif $item['is_top'] == 2}
		    						优先
		    					{elseif $item['is_top'] == 3}
		    						置顶
		    					{elseif $item['is_top'] == 4}
		    						王顶
		    					{else}
		    						否
		    					{/if}	  
		    				</td>  	 	 				 	 	 			 	 		 
		    				<td>{$item['browse']}</td>
		    				<td>{$item['like']}</td>
		    				<td>{$item['forwarding']}</td>
		    				<td>{php echo date('Y-m-d H:i:s',$item['ctime'])}</td>
		    				<td> 	 	 	
		    					<a class="mywidth preview" href="javascript:void(0);" data-id="{$item['id']}">预览</a> 
		    					
		    					<a class="mywidth" href="{php echo $this->createPluginWebUrl('match/picture',array('op'=>'post','id'=>$item['id']))}">修改</a>|
 					 				 	 				 
		    					<a class="mywidth" href="javascript:void(0);" onclick="del({$item['id']})">删除</a>| 		 			
		    					<a class="mywidth" href="{php echo $this->createPluginWebUrl('match/picture',array('op'=>'post','id'=>$item['id'],'ac'=>'clone'))}">复制图片</a>|<br/>
		    					 		
		    					<a class="mywidth team" data-id="{$item['id']}" href="javascript:void(0);">群发设置</a>
		    							 	 	
		    					<a class="mywidth qrcode" data-src="{$item['qrcode']}" href="javascript:void(0);"> 二维码</a>| 		
		    				</td> 					
		    			</tr>
	    			{/loop}
	    		</tbody>
	    	</table>
	    	{$pager}
		</div>
	</div>
</div>


{elseif $op=='draft'}

	<div class='panel panel-default' style="border-radius: 5px;">
    <div class='panel-heading'>草稿箱一共 <span style="color:#f00">{$totals}</span>篇</div>
	    <div class='panel-body'> 	 	  			 
	    	
	    	<table class="table table-hover table-responsive">
	    		<thead class="navbar-inner"> 	
	    			<tr>
	    				<th style="width:auto;">标题</th>
	    				<th style="width:auto;">图片类型</th>
	    				<th style="width:auto;">所属分类</th>
	    				<th style="width:auto;">创建时间</th>
	    				<th style="width:auto;">操作</th>
	    			</tr>
	    		</thead>
	    		<tbody>
	    			{loop $list $index $item}
		    			<tr> 	 	  	 	 	
		    				<td>{$item['title']}</td>
		    				<td>原创</td>
		    				<td>
		    					{if $item['type']}	 			 	  
		    					{$cate[$item['type']]['title']}
		    					{else}
		    					暂无分类
		    					{/if}
		    				</td>
		    				<td>{php echo date('Y-m-d H:i:s',$item['ctime'])}</td>
		    				<td> 		
		    					<a class="mywidth release" href="javascript:void(0);" data-id="{$item['id']}">发布</a> 

		    					<a class="mywidth preview" href="javascript:void(0);" data-id="{$item['id']}">预览</a> 
		    					
		    					<a class="mywidth" href="{php echo $this->createPluginWebUrl('match/picture',array('op'=>'post','id'=>$item['id']))}">修改</a>|

		    					<a class="mywidth" href="javascript:void(0);" onclick="del({$item['id']})">删除</a>|
		    				</td>
		    			</tr>
	    			{/loop}
	    		</tbody>
	    	</table>

		</div>
	</div>
</div>

{else if $_GPC['op'] == 'comment'}

	<div class='panel panel-default' style="border-radius: 5px;">
    <div class='panel-heading'>共有<span style="color:#f00">{$totals}</span>条评论</div>
	    <div class='panel-body'> 		 	 	
	    	
	    	<table class="table table-hover table-responsive">
	    		<thead class="navbar-inner">
	    			<tr>
	    				<th style="width:10%;">图片标题</th>
	    				<th style="width:10%;">评论者</th>
	    				<th style="width:auto;">内容</th>
	    				<th style="width:10%;">发布时间</th>
	    				<th style="width:10%;">当前状态</th>
	    				<th style="width:7%;">操作</th>
	    			</tr>
	    		</thead>
	    		<tbody>
	    			{loop $list $index $item}
		    			<tr> 	 	  	 	 	
		    				<td>{$item['title']}</td>
		    				<td>{$item['nickname']}</td>
		    				<td>{$item['content']}</td>
		    				<td>{php echo date('Y-m-d H:i:s',$item['ctime'])}</td>
		    				<td>
		    					{if $item['status'] == 0}
		    					未审核
		    					{else if $item['status'] == 1}
		    					通过
		    					{else if $item['status'] == 2}
		    					驳回
		    					{/if}
		    				</td>
		    				<td>	 			
		    					{if $item['status'] == 0}
		    					<a class="label label-success" href="{php echo $this->createPluginWebUrl('match/picture',array('op'=>'audit','id'=>$item['id'],'type'=>2,'check'=>1))}">通过</a>
		    					<a class="label label-danger" href="{php echo $this->createPluginWebUrl('match/picture',array('op'=>'audit','id'=>$item['id'],'type'=>2,'check'=>2))}">驳回</a>
		    					{/if}
		    				</td> 	 	 		 
		    			</tr>
	    			{/loop}
	    		</tbody>	 			 	 	 		
	    	</table>
	    	{$pager}
		</div>
	</div>
</div>

{/if}
	

</div>
<script language='javascript'>
 	function del(id){
 			var re = confirm('确定删除该图片吗?');
 			if (!re) {
 				return;	 	 	
 			}
			var data={
				id:id
			};
			$.post('{php echo $this->createPluginWebUrl('match/picture',array('op'=>'delete'))}',data,function(data){
				alert(data.result); 		 	
				if (data.status == 1) {
					location.reload(); 	 	
				} 
			},'json');
		}
     	

     	$('.draft').click(function(){
     		$('[name="data[status]"]').val(2);
     		$(':input[name=submit]').click();
     	});

        $(':input[name=submit]').click(function(){
            if($(this).attr('submitting')=='1'){
                return;
            }

            if ($('[name="reside[province]"]').isEmpty()) {
               Tip.focus($('[name="reside[province]"]'), '请选择省份!');
               return;
            }

            if ($('[name="reside[city]"]').isEmpty()) {
               Tip.focus($('[name="reside[city]"]'), '请选择城市!');
               return;
            }	 	

            /*if ($('[name="reside[district]"]').isEmpty()) {
               Tip.focus($('[name="reside[district]"]'), '请选择地区!');
               return;
            }*/
            
          if ($('[name="data[title]"]').isEmpty()) {
               Tip.focus($('[name="data[title]"]'), '请填写标题!');
               return;
           }

             if ($('[name="data[desc]"]').isEmpty()) {
               Tip.focus($('[name="data[desc]"]'), '请输入摘要!');
               return;
           }

           // if ($('[name="data[content]"]').isEmpty()) {
           //     Tip.focus($('[name="data[bgm]"]'), '请输入填写内容!');
           //     return;
           // }


			var data={
				title:$('[name="data[title]"]').val(),
				desc:$('[name="data[desc]"]').val(),
				relOrg:$('[name="data[relOrg]"]').val(),
				descOrg:$('[name="data[descOrg]"]').val(),
				type:$('input[name="data[type]"]:checked').val(),
				teamModel:$('input[name="data[teamModel]"]:checked').val(),
				bgm:$('[name="data[bgm]"]').val(), 	 	 	
				status:$('input[name="data[status]"]').val(), 	 	 	
				token:$('input[name="token"]').val(), 	 	 	
				id:$('input[name="id"]').val(), 	 	 	
				content:$('[name="data[content]"]').val()
			};

            $(this).attr('submitting','1').removeClass('btn-primary');

            var ajax={
            	type:'post',
            	dataType:'json', 	 	 	 	 	 	 	 	 	 
            	url:"{php echo $this->createPluginWebUrl('match/picture',array('op'=>'post'))}",
				success:function(re){
					alert(re.result.msg);
					if (re.status ==1) { 		 	
						location.href=re.result.url;
					}
					return; 	 	  	 	 
				},
				error:function(re){
                    $(this).removeAttr('submitting').addClass('btn-primary');
                    alert('提交失败!');
                    return;
				} 			 
            }; 	 	
            $('#dataform').ajaxSubmit(ajax);
			$('#dataform').resetForm();            

            return false; 
        })
  
</script>

<div id="modal-module-menus" class="modal fade" tabindex="-1" aria-hidden="false" >
	<div class="modal-dialog" style="width: 450px;margin-top:12%;">
		<div class="modal-content">
			<div class="modal-header"><button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button><h3>图片预览</h3></div>
			<div class="modal-body">
				<input type="hidden" name="atid">
				<input type="text" name="mobile" placeholder="请输入手机号" style="display:inline-block;width:82%;" class="form-control">
				<div class="btn btn-primary" onclick="return send();" style="float: right;width: 18%;">发送</div>	 	
			</div> 	 	 	
			<div class="modal-footer"><a href="#" class="btn btn-default" style="display: none;" data-dismiss="modal" aria-hidden="true">关闭</a></div>
		</div>
	</div>
</div>

<div id="modal-module-teamSend" class="modal fade" tabindex="-1" aria-hidden="false" >
	<div class="modal-dialog" style="width: 450px;margin-top:12%;">
		<div class="modal-content">
			<div class="modal-header"><button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button><h3>群发消息</h3></div>
			<div class="modal-body"> 	 	
				<input type="hidden" name="satid">  	
				<div class="form-group">点击发送后将开始群发消息</div> 	 	
				<div class="btn btn-primary" onclick="return team();" style="float: right;width: 18%;">发送</div>	 	
			</div> 	 	 	 		 		 
			<div class="modal-footer"><a href="#" class="btn btn-default" style="display: none;" data-dismiss="modal" aria-hidden="true">关闭</a></div>
		</div>
	</div>
</div> 

<div id="modal-module-qrcode" class="modal fade" tabindex="-1" aria-hidden="false" >
	<div class="modal-dialog" style="width: 450px;margin-top:12%;">
		<div class="modal-content">
			<div class="modal-header"><button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button><h3>二维码</h3></div>
			<div class="modal-body"> 	 	
				<img src="http://jhzh66.com/attachment/images/8/2018/09/zQttlmbi68t19FentflBmlNVGVV1QV.png">
			</div>
			<h1 class="text-center">点击鼠标右键，图片另存为可保存到本地</1>	 	 	 	 	 		 		 
			<div class="modal-footer"><a href="#" class="btn btn-default" style="display: none;" data-dismiss="modal" aria-hidden="true">关闭</a></div>
		</div>
	</div>
</div> 


<script type="text/javascript">
		
		$('.preview').click(function(){
			$('[name="atid"]').val($(this).data('id'));
			$('#modal-module-menus').modal('show');
		}); 	 	


	$('.preview').click(function(){
		$('[name="atid"]').val($(this).data('id'));
		$('#modal-module-menus').modal('show');
	});

	function send(){
		var data={
			mobile:$('[name="mobile"]').val(),
			atid:$('[name="atid"]').val()
		};

		$.post('{php echo $this->createPluginWebUrl('match/picture',array('op'=>'preview'))}',data,function(data){
			alert(data.result); 		
			if (data.status == 1) {
				$('[name="atid"]').val(null); 	 
				$('[name="mobile"]').val(null); 	 	
			}else{
				$('[name="mobile"]').val(null);	 	 	 
			}	 	 	 	 	
			$('#modal-module-menus').modal('hide');
		},'json'); 		 
	}

	$('.team').click(function(){
		$('[name="satid"]').val($(this).data('id'));
		$('#modal-module-teamSend').modal('show');
	});

	var sending=false;
	function team(){

		if(sending){
			return false;
		}
		sending = true; 		 
 		var id = $('[name="satid"]').val();
		$.post('{php echo $this->createPluginWebUrl('match/picture',array('op'=>'team'))}',{id:id},function(data){
			alert(data.result); 	 		 		
			if (data.status == 1) { 		 
				$('#modal-module-teamSend').modal('hide'); 		
				setTimeout(function(){ 	 			 
					location.reload(); 	 	 
				},250);
				sending=false;
			}	 			 	
		},'json');
	}
	
	$('.qrcode').click(function(){ 	 
		$('#modal-module-qrcode img').attr('src',$(this).data('src'));
		$('#modal-module-qrcode').modal('show');
	});

	$('.release').click(function(){
		var sure=confirm('确定发布该图片吗?');

		if (!sure) {
			return false;
		} 	 	

		var data={
			id:$(this).data('id') 	
		};
		$.post('{php echo $this->createPluginWebUrl('match/picture',array('op'=>'release'))}',data,function(data){
			alert(data.result); 	 	
			if (data.status == 1) { 		 
				setTimeout(function(){ 	 			 
					location.reload(); 	 	 
				},250);
				sending=false;
			}	 		
		},'json');
	});

</script>
<script language="javascript" src="../addons/sz_yi/static/js/myuedit.js"></script>
{template 'common/footer'}